################################################################################
#
#  Configuration Guide for moOde HTTPS mode
#
#  Version: 1.0 2023-12-31
#
#  (C) Tim Curtis 2023 http://moodeaudio.org
#
################################################################################

OVERVIEW

HTTPS mode is an experimental feature in moOde that enables secure communication
between the Browser and moOde/NGINX web server. This is achieved through use of
a self-signed Secure Sockets Layer (SSL) certificate.

This certificate is automatically created and installed into NGINX when HTTPS
mode is turned on. A manual procedure is then required to import the certificate
into the Browser/OS certificate trust store. Once this is done The Browser will
be able to establish secure HTTPS communication with moOde/NGINX.

BASIC PROCEDURE (Desktop OS)

Below is a basic procedure for managing HTTPS mode, configuring Browser
settings and importing the certificate. The detailed steps vary depending on
Browser and Operating System (OS).

1. Turn HTTPS mode ON

a. Open http://moode
b. Turn HTTPS mode ON (in System Config)
c. Reboot

d. Open http://moode or https://moode
e. Browser security warnings will appear and access to moOde will be blocked
f. Click the appropriate button to View the security certificate
g. Click the appropriate button to Export the certificate (specify DER encoding)

h. Open the OS Certificate Trust Store
i. Import the certificate that was exported in the prior step into the System,
   or other appropriate section of the Trust Store
j. View the certificate in the Trust Store and set its Trust policy to "Always"

k. Refresh the Browser and a secure HTTPS connection should be established with
   no Browser warnings

2. Turn HTTPS mode OFF

  a. Open https://moode
  b. Turn HTTPS mode OFF (in System Config)
  c. Reboot

  d. Open http://moode or https://moode
  e. Browser site warnings will appear and moOde will not be accessible
  f. Clear Browser cache and history

  g. Refresh the Browser and a non-secure HTTP connection should be established

Changing the host name

If the host name is changed via System Config a new security certificate will
be automatically generated during startup after reboot. Refresh the Browser and
repeat the certificate export/import procedure starting with step 1d.

BASIC PROCEDURE (Mobile OS)

Content TBD

DEVELOPER INFORMATION

The software components for the HTTPS mode feature are listed below.

PHP SESSION VAR

nginx_https_only

NGINX FILES

/etc/nginx/ssl.conf
/etc/nginx/dhparams.pem
/etc/nginx/sites/available/moode-http.conf
/etc/nginx/sites/available/moode-https.conf

MOODE FILES

/var/www/sys-config.php
/var/www/templates/sys-config.html
/var/www/daemon/worker.php
/var/www/util/gen-cert.sh
/var/www/setup_https.txt

CERTIFICATE

Generated by:
/var/www/util/gen-cert.sh

Certificate files:
/etc/ssl/certs/nginx-selfsigned.crt
/etc/ssl/private/nginx-selfsigned.key

Certificate attribute summary:
Bits            = 2048
Common name     = $HOSTNAME.local
Key usage       = digitalSignature, keyEncipherment, nonRepudiation
Key usage ext   = clientAuth, serverAuth
DNS.1           = $HOSTNAME.local
DNS.2           = $HOSTNAME
IP.1            = 172.24.1.1 (Access point mode)

################################################################################
#  Post questions regarding this guide to http://moodeaudio.org/forum
################################################################################
